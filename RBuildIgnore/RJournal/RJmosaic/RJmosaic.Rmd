---
title: The mosaic package
author:
  - name: Randall Pruim
    affiliation: Calvin College
    address:
    - 3201 Burton St SE
    - Grand Rapids, MI 49546
    email:  rpruim@calvin.edu
  - name: Daniel T Kaplan
    affiliation: Macalester College
    address:
    - address 1
    - address 2
    email:  dtkaplan@macalester.edu
  - name: Nicholas J Horton
    affiliation: Amherst College
    address:
    - address 1
    - address 2
    email:  nhorton@amherst.edu
abstract: >
  The mosaic package provides a simplified and systematic introduction to the core
  functionality required in typical first and second courses in statistics.  This 
  introduction to the package describes some of the guiding principles behind the 
  design of the package and provides illustrative examples of several of the most 
  important functions it provides.
preamble: >
  % Any extra latex you need in the preamble
output: rticles::rjournal_article
---

```{r, include=FALSE}
require(mosaic)
knitr::opts_chunk$set(fig.width = 3, fig.height = 2, fig.show="hold")
options(digits = 3)
trellis.par.set(theme = col.mosaic())
```

# A guiding priciple: Less volume, more creativity

The \CRANpkg{mosaic} package originated in early attempts by each of the authors to 
ease new users into using R, primarily in the context of 
undergraduate statistics courses, and, in one case, also in calculus.
One of the guiding principles behind the development of the \CRANpkg{mosaic} package
has been "Less volume, more creativity".  Beginners are easily overwhelmed by the 
scope of R and its many packages.  Often there are multiple ways to accomplish the 
same task, and authors of the many packages are not required to follow any particular
style guidelines.  

Early on in the development of \CRANpkg{mosaic}, we decided to
reduce the number of code templates that users would need to know to as few as possible,
while still providing them with substantial power to be creative within the
templates provided. 

# The formula template

To successfully implement a "less volume, more creativity" approach, one must decide
which tasks are most important to accomplish.  We knew from the outset, that
this would include graphical and numerical summaries of data and various models
and inference procedures.  Because of this, 
our most important template makes use of a "formula-interface''
modeled after \code{lm()} and the plotting functions in \CRANpkg{lattice}. 

We typically introduce the formula template in the context of exploring 
two variables as 

```{r, eval=FALSE}
goal( y ~ x, data = mydata )
```
\noindent
This template allows us to create, for example, scatterplots and side-by-side box plots
```{r}
xyplot(length ~ width, data = KidsFeet)
bwplot(length ~ sex,   data = KidsFeet)
```
\noindent
With the \CRANpkg{mosaic} package attached, we can use the same template to create 
numerical summaries like
```{r}
mean(length ~ sex, data = KidsFeet)
mean(length ~ sex, data = KidsFeet, .format = "table")
sd(length ~ sex, data = KidsFeet)
favstats(length ~ sex, data = KidsFeet)
```
\noindent
Formula interfaces have been introduced for 
`mean()`, `median()`, 
`sd()`, `var()`, `cor()`, `cov()`,
`quantile()`, 
`max()`, `min()`, `range()`, 
`IQR()`, `iqr()`, `fivenum()`,
`prod()`, and `sum()`.
In each case we have been careful not to break behavior of the underlying functions from
\CRANpkg{base} and \CRANpkg{stats}, but for applications where speed is of utmost 
importance, it is better to avoid the \CRANpkg{mosaic} wrappers, which cannot be faster (since
the call the underlying functions eventually) and may be quite a bit slower for simple 
things.  In particular, using the formula interface requires parsing the formula and 
creating a new object to contain the data described by the formula.
```{r}
microbenchmark::microbenchmark( 
  base::mean(rnorm(1000)), 
  mosaic::mean(rnorm(1000)), 
  mosaic::mean(~ rnorm(1000)))
microbenchmark::microbenchmark( 
  base::mean(rnorm(10000)), 
  mosaic::mean(rnorm(10000)), 
  mosaic::mean(~ rnorm(10000)))
```

On the other hand, for aggregated numerical summaries, the loss in performance may represent
a small price to pay for the simplified syntax.
```{r}
microbenchmark::microbenchmark( 
  with(iris, aggregate(Sepal.Length, list(Species), base::mean)),
  iris %>% 
    sample_frac(size = 1.0, replace = TRUE) %>% 
    group_by(Species) %>% 
    summarise(mean = base::mean(Sepal.Length)),
  mean(Sepal.Length ~ Species, data = resample(iris))
)
```

The formula template can be extended to handle one variable or more than two variables,
but we recommend introducing it in the context of two-variable plots and summaries.  
This is for several reasons: (1) two-variable plots and numerical summariesare are more
``impressive" and less likely to be something students can as readily do with tools they 
already know, (2) working with more than one variable from the start (correctly) suggests
that the most interesting parts of statistics involve more than one variable, and 
(3) the formula syntax for a single variable makes more sense in the context of two-sided
formulas.  

Once the two-variable summaries are understood, we can add a third and forth variable with
```{r, eval=FALSE}
goal( y ~ x | z, groups = mygroups, data=mydata )
```
\noindent
When plotting, `z` is used to create plots with subpanels (or facets) and `groups` is
used overlay multiple layers.  
```{r}
densityplot( ~ age | sex, groups = substance, data = HELPrct)
```
For numerical summaries, these play the same role which allows us to compute 
numerical summaries by changing the name of the plot into the name of the desired
summary.
```{r}
mean( ~ age | sex, groups = substance, data = HELPrct)
```

The one-variable template can be obtained by removing the left-hand side from a 
two-variable template.
```{r, eval=FALSE}
goal( ~ x, data=mydata )
```
\noindent
In the context of plotting, this makes sense since we are providing the data for the 
$x$-axis and allowing R to compute values for the $y$-axis:
```{r}
histogram(~ age, data = HELPrct)
```
\noindent
Numerical summaries fit this pattern by analogy (and because R formulas are required to
have a right hand side).

As students become familiar with the formula interface,
all three forms can be brought together into a single template:

```{r, eval=FALSE}
goal( formula, data=mydata, ... )
```
\noindent
The formula template allows us to very quickly introduce students to 
thinking about relationships between and among two or more variables and
allows them to test conjectures using graphical and numerical summaries.
Having learned the formula interface to graphical and numerical
summaries ealy on, new users are well prepared for modeling with
\code{lm()}, \code{glm()}, and various "test" functions such as
`t.test()` when the time comes. 

## Adding the formula interface to existing functions

Although this formula interface works well for graphical summaries of data
using the \CRANpkg{lattice} package, the same is not true of the standard 
numerical summary functions (\code{mean()}, 
\code{median()}, \code{sd()}, etc.).  One of our initial
difficult decisions was whether to add such a formula interface to these
standard functions (by masking them) or to create new functions.  We decided on the former 
option because the standard names are natural and familiar and because 
having two sets of functions for essentially the same task would be unnecessarily 
complicated for new users.  
The \CRANpkg{mosaic} 
versions of these functions can still be used as in the \CRANpkg{stats} and \CRANpkg{base} packages so that existing code should not be affected, even when
the \CRANpkg{mosaic} package is attached.  (There is, however, a performance penalty
to paid, so when performance is crucial, it may be best to avoid using the \CRANpkg{mosaic}
versions of the standard numerical summary functions.

```{r}
mean( HELPrct$age )
mean( ~ age, data = HELPrct )      # same result as above 
mean( age ~ sex, data = HELPrct )  # additional features are possible
```

There are, of course, other ways to achieve this last result, including the use of 
\code{aggregate()}, or \code{summary()} from \CRANpkg{Hmisc}, or the functions in 
\CRANpkg{plyr}.   But each of these solutions would require learning additional
templates.  In our approach, the following (and many more) are all identical except for 
the specification of the desired result via the function name.

```{r, tidy=FALSE, eval=FALSE}
bwplot( age ~ sex, data=HELPrct )
  mean( age ~ sex, data=HELPrct )
    sd( age ~ sex, data=HELPrct )
    lm( age ~ sex, data=HELPrct )
t.test( age ~ sex, data=HELPrct )   
```

Similarly, by adding additional formula interfaces to `t.test()`,
`binom.test()`, and `prop.test()`, for one-variable situations we have 

```{r, tidy=FALSE, eval=FALSE}
      mean( ~ age, data=HELPrct )
        sd( ~ age, data=HELPrct )
  favstats( ~ age, data=HELPrct )
 histogram( ~ age, data=HELPrct )
    t.test( ~ age, data=HELPrct )       # formula interface added in mosaic
binom.test( ~ sex, data=HELPrct )       # formula interface added in mosaic
 prop.test( ~ sex, data=HELPrct )       # formula interface added in mosaic
```

And for plots and numerical summaries, we can add covariates into the mix as well:
```{r, tidy=FALSE, eval=FALSE}
     mean( ~ age | sex, data=HELPrct )
       sd( ~ age | sex, data=HELPrct )
histogram( ~ age | sex, data=HELPrct )
   t.test( ~ age | sex, data=HELPrct )
```

## Some things that we didn't change

The formula interface is powerful and flexible.  Nevertheless, there are some
sticky issues that we have chosen not to address.

###	The geometry of lattice formulas

		In \code{lm()}, \code{glm()} and the numerical summary functions, \code{y ~ x} can
		typically be read as 
		``\code{y} depends on \code{x}'' or
		``\code{y} is modeled by \code{x}''.  From this perspective,
		
```{r eval=FALSE}
histogram(age ~ sex, data=HELPrct)
```

would be perfectly reasonable.  But \CRANpkg{lattice}, for the most part, 
uses the \code{y} and \code{x} slots to indicate which axis of the plot is used 
for which variable. So the correct \CRANpkg{lattice} command for the desired
pair of histograms is 

```{r, eval=FALSE}
histogram(~ age | sex, data=HELPrct)
```

and for overlaid density plots it is 

```{r eval=FALSE}
densityplot(~ age, groups=sex, data=HELPrct)
```

While this can produce some initial challenges for users, clearly explaining the roles 
of the components of the variables for plotting, for numerical summaries, and for model 
fitting helps demystify the situation.  Furthermore, in several functions we promote formulas
of the form \code{~ x | z} to \code{x ~ z} to allow either format.  Similarly, the \code{groups}
argument can often be used, for example

```{r}
mean( ~ age, groups = sex, data=HELPrct )  
```

### Handling missing data

When there are missing values,
the numerical summary functions in \CRANpkg{base} and \CRANpkg{stats} return
results that surprise and confuse new users.
```{r}
mean( HELPmiss$dayslink )
```
We offer two solutions to this situtation.  Our favorite is the `favstats()` function
which computes a number of our favorite numerical summaries and reports the number of 
missing values.
```{r}
favstats( dayslink ~ sex, data = HELPmiss )
```


## Other stuff as we think of it


# Extracting information

Modeled on functions like \code{resid()}, a number of additional functions have
been added to \CRANpkg{mosaic} to facilitate extracting information from more
complicated objects.  Some examples include

```{r, extractors}
confint(t.test(~age, data=HELPrct))      # works for "htest" objects
pval( t.test(age ~ sex, data=HELPrct))   # works for "htest" objects
stat( t.test(age ~ sex, data=HELPrct))   # works for "htest" objects
r.squared( lm( age ~ sex, data=HELPrct))
```

# Simplifying randomization

## Using do() for repetition

## sample(), resample(), and shuffle()

## do() and confint()

## statTally()


# Calculus in R

# Some additional bells and whistles




## Introduction

Introductory section which may include references in parentheses
\citep{R}, or cite a reference such as \citet{R} in the text.

## Section title in sentence case

This section may contain a figure such as Figure \ref{figure:rlogo}.

\begin{figure}[htbp]
  \centering
  \includegraphics{Rlogo}
  \caption{The logo of R.}
  \label{figure:rlogo}
\end{figure}

## Another section

There will likely be several sections, perhaps including code snippets, such as:

```{r}
x <- 1:10
x
```


## Summary

This file is only a basic article template. For full details of _The R Journal_ style and information on how to prepare your article for submission, see the [Instructions for Authors](http://journal.r-project.org/latex/RJauthorguide.pdf).

## Scrap

This template allows us to create scatterplots and side-by-side box plots
```{r, fig.keep = "none"}
xyplot(length ~ width, data = KidsFeet)
bwplot(length ~ sex,   data = KidsFeet)
```
to create numerical summaries like
```{r}
mean(length ~ sex, data = KidsFeet)
sd(length ~ sex, data = KidsFeet)
favstats(length ~ sex, data = KidsFeet)
```


\bibliography{RJreferences}
%\bibliography{pruim-horton-kaplan}
